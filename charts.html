<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>TeamBrewer</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="https://raw.githubusercontent.com/Eonasdan/bootstrap-datetimepicker/master/build/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
    <script src="js/jquery.js"></script>
    <link href="css/sb-admin.css" rel="stylesheet">
    <link href="css/header.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.2/angular.min.js"></script>
    <link href="css/examples.css" rel="stylesheet" type="text/css">
    <script type="text/javascript">
        var allData = [];

        function convertToTimestamp(date) {



            myDate = date.split("-");
            var newDate = myDate[0] + "/" + myDate[1] + "/" + myDate[2];
            return (new Date(newDate).getTime());
        }

        function convertToDate(timestamp) {


            return moment.unix(timestamp / 1000).format("YYYY-MM-DD");
        }

        function getUrlVars() {

            var vars = [],
                hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');

            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }


            return vars;
        }

        function plotChart($numdays, chartDate) {

            if ($numdays <= 7) {

                $.plot("#placeholder", chartDate, {
                    yaxis: {
                        min: 0,
                        max: 100
                    },
                    xaxis: {
                        mode: "time",
                        minTickSize: [1, "day"],
                        min: (new Date(2015, 6, 1)).getTime(),
                        max: (new Date(2015, 6, 8)).getTime(),
                        timeformat: "%a"
                    }
                });
            } else if ($numdays > 7 && $numdays <= 31) {

                $.plot("#placeholder", chartDate, {
                    yaxis: {
                        min: 0,
                        max: 100
                    },
                    xaxis: {
                        mode: "time",
                        minTickSize: [1, "month"]
                    },
                    series: {
                        lines: {
                            show: true
                        },
                        points: {
                            show: true
                        }
                    },
                    grid: {
                        hoverable: true,
                        clickable: true
                    }
                });
            } else if ($numdays > 31 && $numdays <= 124) {

                $.plot("#placeholder", chartDate, {
                    yaxis: {
                        min: 0,
                        max: 100
                    },
                    xaxis: {
                        mode: "time",
                        minTickSize: [1, "quarter"]
                    },
                    series: {
                        lines: {
                            show: true
                        },
                        points: {
                            show: true
                        }
                    },
                    grid: {
                        hoverable: true,
                        clickable: true
                    },
                    legend: {
                        container: $('#legend-container')
                    }
                });

            }

            $("<div id='tooltip'></div>").css({
                position: "absolute",
                display: "none",
                border: "1px solid #fdd",
                padding: "2px",
                "background-color": "#fee",
                opacity: 0.80
            }).appendTo("body");

            $("#placeholder").bind("plothover", function(event, pos, item) {

                console.log(item);

                if ($("#enablePosition:checked").length > 0) {
                    var str = "(" + pos.x.toFixed(2) + ", " + pos.y.toFixed(2) + ")";
                    $("#hoverdata").text(str);
                }


                if (item) {
                    var x = item.datapoint[0],
                        y = item.datapoint[1];


                    var timestamp = Math.round(item.datapoint[0]);
                    var date = convertToDate(timestamp);
                    console.log(item.series.label + " ::: " + date);


                    var user_id = item.series.custom_id;

                   


                    console.log("this is the user:");
                    console.log(allData[user_id][date]['allocation_list']);

                    console.log('allData');
                    console.log(allData);

                    var htmlString = "";
                    htmlString += (date + "<br><br>");
                   
                    for(var e in allData){
                        
                        if (allData[e][date] && y == allData[e][date]['allocation_total']){

                            htmlString += (allData[e].fullname + "<br>");
                            htmlString += ("Allocation:" + allData[e][date]['allocation_total'] + "%<br>");

                            htmlString += ("Breakdown:<br>");
                            console.log("alloc list:");
                            console.log(allData[e][date]['allocation_list']);

                            for(var i in allData[e][date]['allocation_list']){
                                var project_name = allData[e][date]['allocation_list'][i]['project_name'];
                                var project_alloc = allData[e][date]['allocation_list'][i]['allocation'] + "%";
                                htmlString += project_name + " : " + project_alloc + "<br>";

                            }

                            htmlString += "<br>";
                        }


                        
                    }
                    
                 
                    
                    
                    //alert(item)

                    $("#tooltip").html(htmlString)
                        .css({
                            top: item.pageY + 5,
                            left: item.pageX + 5
                        })
                        .fadeIn(200);
                } else {
                    $("#tooltip").hide();
                }

            });
        }


        $(document).ready(function() {

            var filters = getUrlVars();
            var chartDate = [];

            $.ajax({
                type: "POST",
                url: "API/charts.php",
                data: {
                    from_date: filters.from_date,
                    to_date: filters.to_date,
                    project_id: filters.project_id,
                    team_id: filters.team_id,
                    user_id: filters.user_id
                },
                dataType: 'json',
                async: false,
                success: function(data) {

                    console.log(data);

                    allData = data;

                    for (var i in data) {

                        console.log("USER: " + i);
                        console.log(data[i]);


                        var userData = [];

                        for (var e in data[i]) {
                            var allocation_total = data[i][e]['allocation_total'];

                            if (allocation_total == undefined)
                                allocation_total = 0;

                            console.log("DATE: " + e + " ALLOC:" + allocation_total);

                            userData.push([convertToTimestamp(e), allocation_total]);
                        }

                        //console.log(data);

                        chartDate.push({
                            data: userData,
                            label: data[i]['fullname'],
                            custom_data: ['ABG DDM'],
                            custom_id: i
                        });
                    }
                }
            });

            plotChart(36, chartDate);
        });
    </script>
</head>

<body ng-app="myApp" ng-controller="userCtrl">

    <div id="wrapper">
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <a class="navbar-brand" href="charts.html">teambrewer</a>
            </div>
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <div ng-include="'navbar.html'"></div>
            </div>
        </nav>
        <div id="page-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header">
    Charts

    </h1>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <h2 class="page-header">
    <center>Resource Allocation</center>
    </h2>
                        <form action="charts.html" method="get">
                            <div class="row">
                                <div class="chart-filter-container" class="class_filter" style="text-align:center">
                                    <div class="chart_filter">
                                        <label>Project</label>
                                        <br>
                                        <select id="project_id" name="project_id" ng-model="project_name" class="col-lg">
                                            <option value="">Choose a Project</option>
                                            <option ng-repeat="(key,project) in projects" value="{{ key }}">{{ project.name }}</option>
                                        </select>
                                    </div>
                                    <div class="chart_filter">
                                        <label for='exe3'>Team</label>
                                        <br>
                                        <select name="team_id" ng-model="eteam" class="col-lg">
                                            <option value="">Choose a Team</option>
                                            <option ng-repeat="(key,team) in teams" value="{{ key }}">{{ team.name}}</option>
                                        </select>
                                    </div>
                                    <div class="chart_filter">
                                        <label>From:</label>
                                        <br>
                                        <div class='input-group date' id='datetimepicker1'>
                                            <input name="from_date" type='text' class="form-control" placeholder="YYYY-MM-DD" id="datetimepicker1" value="">
                                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default" ng-click="open">
                                    <i class="glyphicon glyphicon-calendar"></i>
                                </button>
                            </span>
                                        </div>
                                    </div>
                                    <div class="chart_filter">
                                        <label>To:</label>
                                        <br>
                                        <div class='input-group date' id='datetimepicker2'>
                                            <input name="to_date" type='text' class="form-control" placeholder="YYYY-MM-DD" id="datetimepicker2" value="">
                                            <span class="input-group-btn">
                                        <button type="button" class="btn btn-default" ng-click="open">
                                            <i class="glyphicon glyphicon-calendar"></i>
                                        </button>
                                    </span>
                                        </div>
                                    </div>
                                    <div class="chart_filter">
                                        <label for='exe3'>People</label>
                                        <br>
                                        <select name="user_id" ng-model="ename" id="ename" class="col-lg">
                                            <option value="">Choose a Person</option>
                                            <option id="ename" ng-repeat="(key,user) in users " value="{{ key }}">{{user.fullname}}</option>
                                        </select>
                                    </div>
                                    <div class="chart_filter">
                                        <label for='exe3'></label>
                                        <br>
                                        <a class="btn btn-info btn-lg" role="button" data-toggle="collapse" data-target="#colps" aria-expanded="false" aria-controls="colps">
                                            Show List
                                        </a>
                                        <button type="submit" class="btn btn-primary btn-lg">&nbsp;&nbsp;Generate Chart</button>

                                    </div>
                                </div>
                            </div>
                    </div>
                    </form>
                </div>
            </div>
            <br>
            </button>
            <div class="collapse" id="colps">
                <div class="well">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>From</th>
                                            <th>To</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="active" ng-repeat="(key,shed) in sched">
                                            <td>{{ shed.name }}</td>
                                            <td>{{ shed.fromdate }}</td>
                                            <td>{{ shed.todate }}</td>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="content">
                <div class="demo-container">
                    <div id="placeholder" class="demo-placeholder"></div>
                </div>
            </div>
            <div id="legend-container"></div>
        </div>
    </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://raw.githubusercontent.com/moment/moment/develop/moment.js"></script>
    <script src="https://raw.githubusercontent.com/Eonasdan/bootstrap-datetimepicker/master/build/js/bootstrap-datetimepicker.min.js"></script>
    <script>
        $(document).ready(function() {

            $('#datetimepicker1').datetimepicker({
                format: 'YYYY-MM-DD'
            });

            $('#datetimepicker2').datetimepicker({
                format: 'YYYY-MM-DD'
            });
        });
    </script>
    <script src="js/plugins/flot/jquery.flot.js"></script>
    <script src="js/plugins/flot/jquery.flot.time.js"></script>
    <script src="js/plugins/flot/jquery.flot.tooltip.min.js"></script>
    <script src="js/plugins/flot/jquery.flot.resize.js"></script>
    <script src="js/plugins/flot/jquery.flot.pie.js"></script>
    <script src="js/plugins/flot/flot-data.js"></script>
    <script src="charts.js"></script>
</body>

</html>